<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<title>Marion â€” La QuÃªte du Calme IntÃ©rieur</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet"/>
<style>
:root {
  --bg: #0d1117;
  --bg2: #131920;
  --panel: #1a2433;
  --border: rgba(100,180,140,0.2);
  --green: #4caf82;
  --green-glow: #4caf8266;
  --gold: #d4a843;
  --gold-glow: #d4a84350;
  --red: #e05c5c;
  --red-soft: rgba(224,92,92,0.15);
  --blue: #5b9bd5;
  --text: #dde8ee;
  --text-soft: #7a92a3;
  --text-muted: #4a6070;
  --serif: 'Cinzel', serif;
  --sans: 'Lato', sans-serif;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { background:var(--bg); color:var(--text); font-family:var(--sans); min-height:100vh; overflow-x:hidden; }

.stars { position:fixed; inset:0; pointer-events:none; z-index:0;
  background: radial-gradient(ellipse at 20% 30%, rgba(76,175,130,0.08) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 70%, rgba(91,155,213,0.06) 0%, transparent 50%); }

.screen { display:none; min-height:100vh; position:relative; z-index:1; }
.screen.active { display:flex; flex-direction:column; }

/* INTRO */
#intro { align-items:center; justify-content:center; padding:32px 20px; text-align:center; }
.intro-sigil { width:110px; height:110px; margin:0 auto 28px; position:relative; }
.sigil-ring { width:110px; height:110px; border-radius:50%; border:2px solid var(--green); position:absolute;
  box-shadow:0 0 20px var(--green-glow), inset 0 0 20px rgba(76,175,130,0.1); animation:rotate 12s linear infinite; }
.sigil-ring-2 { width:80px; height:80px; top:15px; left:15px; border:1px solid var(--gold);
  animation:rotate 8s linear infinite reverse; box-shadow:0 0 12px var(--gold-glow); }
@keyframes rotate { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
.sigil-core { position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
  font-size:42px; animation:pulse 3s ease-in-out infinite; }
@keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.08)} }
.intro-eyebrow { font-family:var(--serif); font-size:11px; letter-spacing:4px; text-transform:uppercase;
  color:var(--green); margin-bottom:12px; opacity:0.8; }
.intro-title { font-family:var(--serif); font-size:clamp(26px,7vw,40px); font-weight:700; color:var(--text);
  line-height:1.15; margin-bottom:8px; text-shadow:0 0 40px rgba(76,175,130,0.3); }
.intro-title span { color:var(--gold); }
.intro-sub { font-size:14px; color:var(--text-soft); line-height:1.7; margin-bottom:36px;
  max-width:340px; margin-left:auto; margin-right:auto; }
.xp-bar-container { background:var(--panel); border:1px solid var(--border); border-radius:20px;
  padding:16px 20px; margin-bottom:28px; width:100%; max-width:380px; }
.xp-label { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.xp-label-text { font-size:12px; color:var(--text-soft); font-family:var(--serif); letter-spacing:1px; }
.xp-count { font-size:13px; color:var(--gold); font-weight:700; }
.xp-track { height:8px; background:rgba(255,255,255,0.06); border-radius:4px; overflow:hidden; }
.xp-fill { height:100%; background:linear-gradient(90deg,var(--green),#7ed4a0); border-radius:4px;
  transition:width 0.8s cubic-bezier(.4,0,.2,1); box-shadow:0 0 8px var(--green-glow); }
.level-badge { display:inline-flex; align-items:center; gap:8px;
  background:rgba(212,168,67,0.12); border:1px solid rgba(212,168,67,0.3); border-radius:50px;
  padding:8px 20px; font-family:var(--serif); font-size:13px; color:var(--gold); margin-bottom:16px; }
.level-dot { width:8px; height:8px; border-radius:50%; background:var(--gold); box-shadow:0 0 6px var(--gold-glow); }
.btn-quest { display:inline-block; background:linear-gradient(135deg,#2d7a56,#3fa570); color:white;
  border:none; border-radius:14px; padding:18px 40px; font-family:var(--serif); font-size:15px;
  font-weight:600; letter-spacing:1px; cursor:pointer;
  box-shadow:0 4px 24px var(--green-glow), 0 0 0 1px rgba(76,175,130,0.3);
  transition:all 0.25s; text-transform:uppercase; }
.btn-quest:hover { transform:translateY(-2px); box-shadow:0 8px 36px var(--green-glow); }
.btn-quest:active { transform:translateY(0); }

/* MAP */
#map { flex-direction:column; }
.map-header { padding:20px 20px 0; display:flex; justify-content:space-between; align-items:center; }
.map-header-title { font-family:var(--serif); font-size:16px; color:var(--green); }
.map-header-xp { display:flex; align-items:center; gap:6px; font-size:12px; color:var(--gold); }
.map-xp-mini { width:100px; height:6px; background:rgba(255,255,255,0.06); border-radius:3px; overflow:hidden; }
.map-xp-mini-fill { height:100%; background:var(--gold); border-radius:3px; transition:width 0.6s; }
.map-scroll { padding:16px 20px 100px; }
.map-world-title { font-family:var(--serif); font-size:11px; letter-spacing:3px; text-transform:uppercase;
  color:var(--text-muted); margin-bottom:18px; margin-top:16px; }
.stat-strip { background:var(--panel); border:1px solid var(--border); border-radius:14px;
  padding:14px 18px; margin-bottom:16px; display:flex; }
.stat-item { flex:1; text-align:center; }
.stat-item + .stat-item { border-left:1px solid var(--border); }
.stat-val { font-family:var(--serif); font-size:22px; color:var(--gold); }
.stat-lbl { font-size:10px; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-top:2px; }

/* LEVEL CARDS */
.level-card { background:var(--panel); border:1px solid var(--border); border-radius:18px;
  padding:20px 18px; margin-bottom:12px; cursor:pointer; transition:all 0.25s; position:relative; overflow:hidden; }
.level-card::before { content:''; position:absolute; top:0; left:0; right:0; height:2px;
  background:linear-gradient(90deg,var(--green),transparent); transform:scaleX(0);
  transform-origin:left; transition:transform 0.3s; }
.level-card:hover::before { transform:scaleX(1); }
.level-card:hover { border-color:rgba(76,175,130,0.4); transform:translateY(-2px); }
.level-card.locked { opacity:0.45; cursor:not-allowed; }
.level-card.locked:hover { transform:none; border-color:var(--border); }
.level-card.completed { border-color:rgba(76,175,130,0.5); }
.level-card.completed::before { transform:scaleX(1); background:linear-gradient(90deg,var(--green),#7ed4a0); }
.level-card-top { display:flex; gap:14px; align-items:flex-start; margin-bottom:12px; }
.level-icon { width:52px; height:52px; border-radius:14px; display:flex; align-items:center;
  justify-content:center; font-size:24px; flex-shrink:0; }
.level-icon.green { background:rgba(76,175,130,0.15); }
.level-icon.gold { background:rgba(212,168,67,0.15); }
.level-icon.blue { background:rgba(91,155,213,0.15); }
.level-icon.red { background:rgba(224,92,92,0.15); }
.level-icon.purple { background:rgba(160,120,200,0.15); }
.level-num { font-size:10px; letter-spacing:2px; text-transform:uppercase; color:var(--text-muted); margin-bottom:2px; font-family:var(--serif); }
.level-name { font-family:var(--serif); font-size:17px; font-weight:600; color:var(--text); margin-bottom:3px; }
.level-desc { font-size:12px; color:var(--text-soft); line-height:1.4; }
.level-footer { display:flex; gap:8px; flex-wrap:wrap; }
.tag { display:inline-flex; align-items:center; gap:4px; background:rgba(255,255,255,0.04);
  border:1px solid rgba(255,255,255,0.08); border-radius:20px; padding:4px 10px;
  font-size:11px; color:var(--text-soft); }
.tag.green { border-color:rgba(76,175,130,0.3); color:var(--green); background:rgba(76,175,130,0.07); }
.tag.gold { border-color:rgba(212,168,67,0.3); color:var(--gold); background:rgba(212,168,67,0.07); }
.lock-icon { margin-left:auto; font-size:18px; opacity:0.4; }
.check-icon { margin-left:auto; font-size:18px; color:var(--green); }
.boss-card { background:linear-gradient(135deg,rgba(224,92,92,0.1),rgba(160,80,80,0.08));
  border:1px solid rgba(224,92,92,0.3); border-radius:18px; padding:22px 18px;
  margin-bottom:12px; position:relative; overflow:hidden; cursor:pointer; }
.boss-card::before { content:''; position:absolute; top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,var(--red),rgba(224,92,92,0.2)); }
.boss-badge { display:inline-flex; align-items:center; gap:6px; background:rgba(224,92,92,0.15);
  border:1px solid rgba(224,92,92,0.3); border-radius:20px; padding:4px 12px;
  font-size:10px; font-family:var(--serif); letter-spacing:2px; color:var(--red);
  text-transform:uppercase; margin-bottom:12px; }
.boss-name { font-family:var(--serif); font-size:20px; font-weight:700; color:var(--text); margin-bottom:4px; }
.boss-desc { font-size:12px; color:var(--text-soft); line-height:1.5; }

/* PLAY */
#play { flex-direction:column; }
.play-header { padding:16px 20px; display:flex; align-items:center; gap:12px; border-bottom:1px solid var(--border); }
.back-btn { width:36px; height:36px; background:rgba(255,255,255,0.06); border:1px solid var(--border);
  border-radius:10px; display:flex; align-items:center; justify-content:center;
  cursor:pointer; color:var(--text-soft); font-size:16px; transition:all 0.2s; }
.back-btn:hover { background:rgba(76,175,130,0.1); color:var(--green); border-color:var(--green); }
.play-header-info { flex:1; }
.play-level-num { font-size:10px; letter-spacing:2px; color:var(--text-muted); font-family:var(--serif); text-transform:uppercase; }
.play-level-name { font-family:var(--serif); font-size:17px; color:var(--text); }
.play-xp { font-size:12px; color:var(--gold); }
.step-progress { padding:16px 20px 8px; }
.step-dots { display:flex; gap:6px; }
.step-dot { flex:1; height:4px; border-radius:2px; background:rgba(255,255,255,0.08); transition:background 0.4s; }
.step-dot.done { background:var(--green); box-shadow:0 0 6px var(--green-glow); }
.step-dot.active { background:var(--gold); box-shadow:0 0 6px var(--gold-glow); animation:blink 1.5s ease-in-out infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.5} }
.play-body { padding:20px 20px 120px; flex:1; }
.step-card { background:var(--panel); border:1px solid var(--border); border-radius:20px;
  padding:28px 22px; animation:fadeInUp 0.35s ease; }
@keyframes fadeInUp { from{opacity:0;transform:translateY(16px)} to{opacity:1;transform:translateY(0)} }
.step-emoji { font-size:44px; margin-bottom:16px; text-align:center; }
.step-title { font-family:var(--serif); font-size:22px; font-weight:600; margin-bottom:10px; }
.step-text { font-size:14px; color:var(--text-soft); line-height:1.75; margin-bottom:20px; }
.step-text strong { color:var(--text); font-weight:700; }
.step-text .highlight { background:rgba(76,175,130,0.1); border-left:3px solid var(--green);
  border-radius:0 8px 8px 0; padding:10px 14px; display:block; margin:12px 0;
  font-size:13px; color:var(--text); line-height:1.6; }
.step-text .danger { background:var(--red-soft); border-left:3px solid var(--red);
  border-radius:0 8px 8px 0; padding:10px 14px; display:block; margin:12px 0;
  font-size:13px; color:var(--text); line-height:1.6; }
.choices { display:flex; flex-direction:column; gap:10px; margin-top:8px; }
.choice-btn { background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.1);
  border-radius:12px; padding:16px 18px; font-family:var(--sans); font-size:14px;
  color:var(--text); cursor:pointer; text-align:left; transition:all 0.2s; line-height:1.4; }
.choice-btn:hover { background:rgba(76,175,130,0.1); border-color:var(--green); }
.choice-btn.correct { background:rgba(76,175,130,0.15); border-color:var(--green); color:var(--green); }
.choice-btn.wrong { background:var(--red-soft); border-color:var(--red); color:var(--red); }
.choice-btn:disabled { cursor:default; }
.breath-mini { display:flex; flex-direction:column; align-items:center; padding:20px 0; }
.breath-orb { width:100px; height:100px; border-radius:50%;
  background:radial-gradient(circle,rgba(76,175,130,0.3),rgba(76,175,130,0.05));
  border:2px solid var(--green); box-shadow:0 0 20px var(--green-glow);
  display:flex; align-items:center; justify-content:center;
  font-size:13px; color:var(--green); font-family:var(--serif);
  transition:transform 4s ease, box-shadow 4s ease; margin-bottom:16px; cursor:pointer; }
.breath-orb.expand { transform:scale(1.5); box-shadow:0 0 50px var(--green-glow); }
.breath-orb.shrink { transform:scale(0.75); box-shadow:0 0 8px var(--green-glow); }
.breath-instruction { font-size:14px; color:var(--text-soft); text-align:center; margin-bottom:8px; }
.breath-timer { font-family:var(--serif); font-size:32px; color:var(--green); }
.reflection-input { width:100%; background:rgba(255,255,255,0.04); border:1px solid var(--border);
  border-radius:12px; padding:16px; font-family:var(--sans); font-size:14px; color:var(--text);
  resize:none; height:110px; outline:none; transition:border-color 0.2s; margin-top:8px; }
.reflection-input:focus { border-color:var(--green); }
.reflection-input::placeholder { color:var(--text-muted); }
.audio-play-card { background:rgba(76,175,130,0.05); border:1px solid rgba(76,175,130,0.2);
  border-radius:16px; padding:20px; display:flex; align-items:center; gap:16px;
  cursor:pointer; transition:all 0.25s; margin-top:8px; }
.audio-play-card:hover { background:rgba(76,175,130,0.1); border-color:rgba(76,175,130,0.4); }
.audio-play-btn { width:54px; height:54px; border-radius:50%;
  background:linear-gradient(135deg,#2d7a56,#4caf82); display:flex; align-items:center;
  justify-content:center; box-shadow:0 4px 16px var(--green-glow); flex-shrink:0; font-size:20px; }
.audio-play-title { font-family:var(--serif); font-size:16px; margin-bottom:3px; }
.audio-play-sub { font-size:12px; color:var(--text-soft); }
.audio-play-duration { font-size:11px; color:var(--green); margin-top:5px; font-weight:700; }

/* REWARD */
#reward { align-items:center; justify-content:center; text-align:center; padding:32px 24px;
  background:radial-gradient(ellipse at center,rgba(212,168,67,0.08) 0%,transparent 60%); }
.reward-burst { font-size:80px; margin-bottom:20px; animation:burst 0.6s cubic-bezier(.2,2,.4,1); }
@keyframes burst { from{transform:scale(0);opacity:0} to{transform:scale(1);opacity:1} }
.reward-title { font-family:var(--serif); font-size:32px; font-weight:700; color:var(--gold);
  margin-bottom:8px; text-shadow:0 0 30px var(--gold-glow); }
.reward-sub { font-size:14px; color:var(--text-soft); margin-bottom:28px; line-height:1.6; }
.reward-xp-gain { display:inline-flex; align-items:center; gap:8px;
  background:rgba(212,168,67,0.12); border:1px solid rgba(212,168,67,0.3);
  border-radius:50px; padding:12px 28px; font-family:var(--serif); font-size:18px;
  color:var(--gold); margin-bottom:28px; }
.reward-unlock { background:var(--panel); border:1px solid var(--border); border-radius:16px;
  padding:16px 20px; margin-bottom:28px; text-align:left; }
.reward-unlock-label { font-size:10px; letter-spacing:2px; color:var(--text-muted);
  text-transform:uppercase; font-family:var(--serif); margin-bottom:6px; }
.reward-unlock-text { font-size:14px; color:var(--text); }

/* NAV */
.bottom-nav { position:fixed; bottom:0; left:0; right:0; z-index:50;
  background:rgba(13,17,23,0.95); backdrop-filter:blur(12px);
  border-top:1px solid var(--border); display:flex; }
.nav-it { flex:1; display:flex; flex-direction:column; align-items:center;
  padding:12px 0 10px; cursor:pointer; color:var(--text-muted); font-size:10px;
  gap:4px; transition:color 0.2s; font-family:var(--serif); letter-spacing:0.5px; }
.nav-it.active { color:var(--green); }
.nav-it svg { width:22px; height:22px; }

/* TOAST */
.toast { position:fixed; bottom:90px; left:50%; transform:translateX(-50%) translateY(10px);
  background:var(--panel); border:1px solid var(--green); color:var(--text); border-radius:50px;
  padding:12px 24px; font-size:13px; opacity:0; transition:all 0.3s; z-index:200;
  white-space:nowrap; box-shadow:0 4px 20px var(--green-glow); }
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }

/* PLAYER */
.player-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7);
  backdrop-filter:blur(10px); z-index:300; align-items:flex-end; }
.player-overlay.open { display:flex; }
.player-sheet { background:var(--panel); border-top:1px solid var(--border);
  border-radius:28px 28px 0 0; padding:28px 24px 52px; width:100%; animation:slideUp 0.3s ease; }
@keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
.player-handle { width:40px;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;margin:0 auto 24px;cursor:pointer; }
.player-track { font-family:var(--serif);font-size:22px;margin-bottom:4px; }
.player-sub { font-size:12px;color:var(--text-soft);margin-bottom:24px; }
.player-waves { height:60px;display:flex;align-items:center;gap:2px;background:rgba(255,255,255,0.03);border-radius:10px;margin-bottom:20px;padding:0 10px;overflow:hidden; }
.wbar { width:3px;border-radius:2px;background:var(--green);animation:wav 1.3s ease-in-out infinite; }
@keyframes wav { 0%,100%{height:4px;opacity:0.3} 50%{height:36px;opacity:1} }
.player-progress { width:100%;height:4px;background:rgba(255,255,255,0.08);border-radius:2px;cursor:pointer;margin-bottom:6px;position:relative; }
.player-progress-fill { height:100%;background:linear-gradient(90deg,var(--green),#7ed4a0);border-radius:2px;width:0%;transition:width 0.5s linear; }
.player-times { display:flex;justify-content:space-between;font-size:11px;color:var(--text-muted);margin-bottom:24px; }
.player-controls { display:flex;align-items:center;justify-content:center;gap:24px; }
.ctrl { background:none;border:none;color:var(--text-soft);cursor:pointer;opacity:0.7;transition:all 0.2s;font-size:14px;font-family:var(--sans); }
.ctrl:hover{opacity:1;color:var(--text);}
.ctrl-main { width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#2d7a56,#4caf82);display:flex;align-items:center;justify-content:center;box-shadow:0 0 24px var(--green-glow);font-size:22px;cursor:pointer;transition:all 0.2s;border:none; }
.ctrl-main:hover{transform:scale(1.05);}
</style>
</head>
<body>
<div class="stars"></div>
<div class="toast" id="toast"></div>

<!-- â•â• INTRO â•â• -->
<div class="screen active" id="intro">
  <div class="intro-sigil">
    <div class="sigil-ring"></div>
    <div class="sigil-ring sigil-ring-2"></div>
    <div class="sigil-core">ğŸŒ¿</div>
  </div>
  <p class="intro-eyebrow">Parcours thÃ©rapeutique de</p>
  <h1 class="intro-title">Marion<br><span>La QuÃªte du Calme</span></h1>
  <p class="intro-sub">Un voyage par niveaux pour apprivoiser la peur d'avoir peur â€” et retrouver la confiance en votre corps.</p>
  <div class="xp-bar-container" style="max-width:360px">
    <div class="xp-label">
      <span class="xp-label-text">âš¡ Points d'expÃ©rience</span>
      <span class="xp-count" id="intro-xp-text">0 XP</span>
    </div>
    <div class="xp-track"><div class="xp-fill" id="intro-xp-bar" style="width:0%"></div></div>
  </div>
  <div class="level-badge"><div class="level-dot"></div><span id="intro-level-text">Niveau 1 â€” L'Ã‰veil</span></div>
  <br>
  <button class="btn-quest" onclick="nav('map')">âš”ï¸ &nbsp;Commencer la quÃªte</button>
</div>

<!-- â•â• MAP â•â• -->
<div class="screen" id="map">
  <div class="map-header">
    <div class="map-header-title">ğŸ—ºï¸ Carte du monde</div>
    <div class="map-header-xp">
      <span id="map-xp-label">0 XP</span>
      <div class="map-xp-mini"><div class="map-xp-mini-fill" id="map-xp-fill" style="width:0%"></div></div>
    </div>
  </div>
  <div class="map-scroll">
    <div class="stat-strip">
      <div class="stat-item"><div class="stat-val" id="stat-levels">0</div><div class="stat-lbl">Niveaux</div></div>
      <div class="stat-item"><div class="stat-val" id="stat-xp">0</div><div class="stat-lbl">XP total</div></div>
      <div class="stat-item"><div class="stat-val">ğŸ”¥ <span id="stat-streak">1</span></div><div class="stat-lbl">SÃ©rie</div></div>
    </div>

    <p class="map-world-title">âš”ï¸ Monde I â€” Comprendre la Peur</p>

    <div class="level-card" id="lcard-0" onclick="startLevel(0)">
      <div class="level-card-top">
        <div class="level-icon green">ğŸ§ </div>
        <div class="level-info">
          <div class="level-num">Niveau 1</div>
          <div class="level-name">La Peur d'avoir Peur</div>
          <div class="level-desc">Comprendre pourquoi votre cerveau sonne l'alarme mÃªme sans danger rÃ©el.</div>
        </div>
        <span class="check-icon" id="check-0" style="display:none">âœ…</span>
        <span class="lock-icon" id="lock-0" style="display:none">ğŸ”’</span>
      </div>
      <div class="level-footer"><span class="tag green">ğŸ¯ TCC</span><span class="tag">5 Ã©tapes</span><span class="tag gold">+80 XP</span></div>
    </div>

    <div class="level-card locked" id="lcard-1" onclick="startLevel(1)">
      <div class="level-card-top">
        <div class="level-icon blue">ğŸ«</div>
        <div class="level-info">
          <div class="level-num">Niveau 2</div>
          <div class="level-name">Votre Corps n'est pas l'Ennemi</div>
          <div class="level-desc">Le SCI et l'anxiÃ©tÃ© : comprendre l'axe intestin-cerveau sans paniquer.</div>
        </div>
        <span class="check-icon" id="check-1" style="display:none">âœ…</span>
        <span class="lock-icon" id="lock-1">ğŸ”’</span>
      </div>
      <div class="level-footer"><span class="tag blue">ğŸ« SCI</span><span class="tag">6 Ã©tapes</span><span class="tag gold">+100 XP</span></div>
    </div>

    <div class="level-card locked" id="lcard-2" onclick="startLevel(2)">
      <div class="level-card-top">
        <div class="level-icon gold">ğŸŒ€</div>
        <div class="level-info">
          <div class="level-num">Niveau 3</div>
          <div class="level-name">Le Cercle Vicieux</div>
          <div class="level-desc">Cartographier votre cycle anxieux et identifier vos dÃ©clencheurs personnels.</div>
        </div>
        <span class="check-icon" id="check-2" style="display:none">âœ…</span>
        <span class="lock-icon" id="lock-2">ğŸ”’</span>
      </div>
      <div class="level-footer"><span class="tag">ğŸ—ºï¸ Cartographie</span><span class="tag">5 Ã©tapes</span><span class="tag gold">+90 XP</span></div>
    </div>

    <p class="map-world-title">ğŸŒŠ Monde II â€” Les Outils du Guerrier</p>

    <div class="level-card locked" id="lcard-3" onclick="startLevel(3)">
      <div class="level-card-top">
        <div class="level-icon green">ğŸŒ¬ï¸</div>
        <div class="level-info">
          <div class="level-num">Niveau 4</div>
          <div class="level-name">Souffle & CohÃ©rence</div>
          <div class="level-desc">MaÃ®triser la respiration 4-4-6 pour calmer le systÃ¨me nerveux en 90 secondes.</div>
        </div>
        <span class="check-icon" id="check-3" style="display:none">âœ…</span>
        <span class="lock-icon" id="lock-3">ğŸ”’</span>
      </div>
      <div class="level-footer"><span class="tag green">ğŸŒ¬ï¸ Respiration</span><span class="tag">5 Ã©tapes</span><span class="tag gold">+80 XP</span></div>
    </div>

    <div class="level-card locked" id="lcard-4" onclick="startLevel(4)">
      <div class="level-card-top">
        <div class="level-icon purple">ğŸ§</div>
        <div class="level-info">
          <div class="level-num">Niveau 5</div>
          <div class="level-name">Le Sanctuaire IntÃ©rieur</div>
          <div class="level-desc">PremiÃ¨re sÃ©ance d'autohypnose â€” induction et crÃ©ation de votre lieu sÃ»r.</div>
        </div>
        <span class="check-icon" id="check-4" style="display:none">âœ…</span>
        <span class="lock-icon" id="lock-4">ğŸ”’</span>
      </div>
      <div class="level-footer"><span class="tag">ğŸ§ Hypnose</span><span class="tag">4 Ã©tapes</span><span class="tag gold">+120 XP</span></div>
    </div>

    <div class="level-card locked" id="lcard-5" onclick="startLevel(5)">
      <div class="level-card-top">
        <div class="level-icon gold">âš¡</div>
        <div class="level-info">
          <div class="level-num">Niveau 6</div>
          <div class="level-name">Restructurer les PensÃ©es</div>
          <div class="level-desc">Transformer les pensÃ©es catastrophiques en pensÃ©es ancrÃ©es dans la rÃ©alitÃ©.</div>
        </div>
        <span class="check-icon" id="check-5" style="display:none">âœ…</span>
        <span class="lock-icon" id="lock-5">ğŸ”’</span>
      </div>
      <div class="level-footer"><span class="tag gold">ğŸ’­ TCC avancÃ©</span><span class="tag">6 Ã©tapes</span><span class="tag gold">+110 XP</span></div>
    </div>

    <p class="map-world-title">ğŸ”¥ Monde III â€” Affronter & Vaincre</p>

    <div class="level-card locked" id="lcard-6" onclick="startLevel(6)">
      <div class="level-card-top">
        <div class="level-icon red">ğŸš¶</div>
        <div class="level-info">
          <div class="level-num">Niveau 7</div>
          <div class="level-name">L'Exposition GraduÃ©e</div>
          <div class="level-desc">Affronter les situations redoutÃ©es, pas Ã  pas, sans fuir.</div>
        </div>
        <span class="check-icon" id="check-6" style="display:none">âœ…</span>
        <span class="lock-icon" id="lock-6">ğŸ”’</span>
      </div>
      <div class="level-footer"><span class="tag">ğŸ¯ Exposition</span><span class="tag">5 Ã©tapes</span><span class="tag gold">+130 XP</span></div>
    </div>

    <div class="boss-card" id="lcard-7" onclick="startLevel(7)">
      <div class="boss-badge">ğŸ’€ Niveau Final</div>
      <div class="level-card-top" style="margin-bottom:12px">
        <div class="level-icon red" style="font-size:28px">ğŸ‰</div>
        <div class="level-info">
          <div class="boss-name">Vaincre la Peur de la Peur</div>
          <div class="boss-desc">Le combat final : intÃ©grer toutes les compÃ©tences et crÃ©er votre plan de vie.</div>
        </div>
        <span class="lock-icon" id="lock-7">ğŸ”’</span>
        <span class="check-icon" id="check-7" style="display:none">âœ…</span>
      </div>
      <div class="level-footer">
        <span class="tag" style="border-color:rgba(224,92,92,0.3);color:var(--red);">ğŸ‘‘ Boss Final</span>
        <span class="tag gold">+200 XP</span>
      </div>
    </div>
  </div>

  <nav class="bottom-nav">
    <div class="nav-it active" onclick="nav('map')">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg>
      Carte
    </div>
    <div class="nav-it" onclick="nav('journal-sc')">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
      Journal
    </div>
    <div class="nav-it" onclick="nav('audio-sc')">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
      Hypnose
    </div>
  </nav>
</div>

<!-- â•â• PLAY â•â• -->
<div class="screen" id="play">
  <div class="play-header">
    <div class="back-btn" onclick="nav('map')">â†</div>
    <div class="play-header-info">
      <div class="play-level-num" id="play-level-num">Niveau 1</div>
      <div class="play-level-name" id="play-level-name">â€”</div>
    </div>
    <div class="play-xp">âš¡ <span id="play-xp-reward">+80 XP</span></div>
  </div>
  <div class="step-progress"><div class="step-dots" id="step-dots"></div></div>
  <div class="play-body" id="play-body"></div>
  <div style="position:fixed;bottom:0;left:0;right:0;padding:16px 20px;background:linear-gradient(transparent,var(--bg) 40%);z-index:40;">
    <button class="btn-quest" id="next-btn" style="width:100%;text-align:center;" onclick="nextStep()">Continuer â†’</button>
  </div>
</div>

<!-- â•â• REWARD â•â• -->
<div class="screen" id="reward">
  <div class="reward-burst" id="reward-emoji">ğŸ†</div>
  <div class="reward-title" id="reward-title">Niveau accompli !</div>
  <div class="reward-sub" id="reward-sub">Vous avancez sur votre chemin.</div>
  <div class="reward-xp-gain" id="reward-xp">âš¡ +80 XP</div>
  <div class="reward-unlock" id="reward-unlock">
    <div class="reward-unlock-label">ğŸ”“ DÃ©bloquÃ©</div>
    <div class="reward-unlock-text" id="reward-unlock-text">Niveau suivant disponible !</div>
  </div>
  <button class="btn-quest" onclick="nav('map')">Retour Ã  la carte â†’</button>
</div>

<!-- â•â• JOURNAL â•â• -->
<div class="screen" id="journal-sc">
  <div class="play-header">
    <div class="back-btn" onclick="nav('map')">â†</div>
    <div class="play-header-info">
      <div class="play-level-num">Journal de quÃªte</div>
      <div class="play-level-name">Mes Ã©motions & pensÃ©es</div>
    </div>
  </div>
  <div class="play-body" style="padding-bottom:100px">
    <div class="step-card">
      <div class="step-emoji">ğŸ““</div>
      <div class="step-title">Comment je me sens ?</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;">
        <div class="choice-btn" style="text-align:center;padding:14px 8px;" onclick="pickEmotion(this,'ğŸ˜Œ')"><div style="font-size:26px">ğŸ˜Œ</div><div style="font-size:11px;margin-top:4px;color:var(--text-soft)">Sereine</div></div>
        <div class="choice-btn" style="text-align:center;padding:14px 8px;" onclick="pickEmotion(this,'ğŸ˜°')"><div style="font-size:26px">ğŸ˜°</div><div style="font-size:11px;margin-top:4px;color:var(--text-soft)">Anxieuse</div></div>
        <div class="choice-btn" style="text-align:center;padding:14px 8px;" onclick="pickEmotion(this,'ğŸ¤¢')"><div style="font-size:26px">ğŸ¤¢</div><div style="font-size:11px;margin-top:4px;color:var(--text-soft)">Inconfort</div></div>
        <div class="choice-btn" style="text-align:center;padding:14px 8px;" onclick="pickEmotion(this,'ğŸ˜”')"><div style="font-size:26px">ğŸ˜”</div><div style="font-size:11px;margin-top:4px;color:var(--text-soft)">Triste</div></div>
        <div class="choice-btn" style="text-align:center;padding:14px 8px;" onclick="pickEmotion(this,'ğŸ’ª')"><div style="font-size:26px">ğŸ’ª</div><div style="font-size:11px;margin-top:4px;color:var(--text-soft)">Courageuse</div></div>
        <div class="choice-btn" style="text-align:center;padding:14px 8px;" onclick="pickEmotion(this,'ğŸ˜´')"><div style="font-size:26px">ğŸ˜´</div><div style="font-size:11px;margin-top:4px;color:var(--text-soft)">FatiguÃ©e</div></div>
      </div>
      <p style="font-size:13px;color:var(--text-soft);margin-bottom:8px;">Qu'est-ce que je remarque en moi aujourd'hui ?</p>
      <textarea class="reflection-input" id="journal-ta" placeholder="PensÃ©es, sensations corporelles, ce qui m'a dÃ©clenchÃ©..."></textarea>
      <button class="btn-quest" style="width:100%;margin-top:14px;" onclick="saveJournal()">Enregistrer âœ“</button>
    </div>
    <div id="journal-entries" style="margin-top:20px;display:flex;flex-direction:column;gap:10px;"></div>
  </div>
  <nav class="bottom-nav">
    <div class="nav-it" onclick="nav('map')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg>Carte</div>
    <div class="nav-it active" onclick="nav('journal-sc')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>Journal</div>
    <div class="nav-it" onclick="nav('audio-sc')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>Hypnose</div>
  </nav>
</div>

<!-- â•â• AUDIO â•â• -->
<div class="screen" id="audio-sc">
  <div class="play-header">
    <div class="back-btn" onclick="nav('map')">â†</div>
    <div class="play-header-info">
      <div class="play-level-num">SÃ©ances d'autohypnose</div>
      <div class="play-level-name">Induction + travail ciblÃ©</div>
    </div>
  </div>
  <div class="play-body" style="padding-bottom:100px">
    <div style="background:rgba(76,175,130,0.05);border:1px solid rgba(76,175,130,0.15);border-radius:14px;padding:14px 16px;margin-bottom:20px;font-size:13px;color:var(--text-soft);line-height:1.6;">
      ğŸŒ€ Chaque sÃ©ance commence par une <strong style="color:var(--text)">induction progressive</strong>. Placez vos fichiers dans le dossier <code>audio/</code>.
    </div>
    <div class="audio-play-card" onclick="openAudio('Relaxation','Induction progressive, dÃ©tente complÃ¨te','audio/seance-relaxation.mp3','~20 min')">
      <div class="audio-play-btn">â–¶</div>
      <div class="audio-play-info"><div class="audio-play-title">Relaxation & LÃ¢cher-prise</div><div class="audio-play-sub">Induction progressive â†’ corps et esprit apaisÃ©s</div><div class="audio-play-duration">ğŸ• ~20 min</div></div>
    </div>
    <div class="audio-play-card" onclick="openAudio('Apprivoiser l\'AnxiÃ©tÃ©','Induction, sÃ©curitÃ© intÃ©rieure','audio/seance-anxiete.mp3','~18 min')">
      <div class="audio-play-btn">â–¶</div>
      <div class="audio-play-info"><div class="audio-play-title">Apprivoiser l'AnxiÃ©tÃ©</div><div class="audio-play-sub">Induction â†’ lieu sÃ»r, dissoudre la peur de la peur</div><div class="audio-play-duration">ğŸ• ~18 min</div></div>
    </div>
    <div class="audio-play-card" onclick="openAudio('Paix Intestinale','Induction, dialogue avec votre intestin','audio/seance-sci.mp3','~22 min')">
      <div class="audio-play-btn">â–¶</div>
      <div class="audio-play-info"><div class="audio-play-title">Paix Intestinale âœ¨</div><div class="audio-play-sub">Induction â†’ confiance en votre corps, SCI</div><div class="audio-play-duration">ğŸ• ~22 min</div></div>
    </div>
    <div class="audio-play-card" onclick="openAudio('Confiance en Soi','Induction, ancrage de confiance','audio/seance-confiance.mp3','~15 min')">
      <div class="audio-play-btn">â–¶</div>
      <div class="audio-play-info"><div class="audio-play-title">Confiance en Soi</div><div class="audio-play-sub">Induction â†’ renforcement intÃ©rieur</div><div class="audio-play-duration">ğŸ• ~15 min</div></div>
    </div>
    <div class="audio-play-card" onclick="openAudio('Sommeil Profond','Induction douce pour le soir','audio/seance-sommeil.mp3','~25 min')">
      <div class="audio-play-btn">â–¶</div>
      <div class="audio-play-info"><div class="audio-play-title">Sommeil Profond</div><div class="audio-play-sub">Induction douce â†’ endormissement naturel</div><div class="audio-play-duration">ğŸ• ~25 min</div></div>
    </div>
  </div>
  <nav class="bottom-nav">
    <div class="nav-it" onclick="nav('map')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.5 3l-.16.03L15 5.1 9 3 3.36 4.9c-.21.07-.36.25-.36.48V20.5c0 .28.22.5.5.5l.16-.03L9 18.9l6 2.1 5.64-1.9c.21-.07.36-.25.36-.48V3.5c0-.28-.22-.5-.5-.5zM15 19l-6-2.11V5l6 2.11V19z"/></svg>Carte</div>
    <div class="nav-it" onclick="nav('journal-sc')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>Journal</div>
    <div class="nav-it active" onclick="nav('audio-sc')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>Hypnose</div>
  </nav>
</div>

<!-- AUDIO PLAYER OVERLAY -->
<div class="player-overlay" id="po">
  <div class="player-sheet">
    <div class="player-handle" onclick="closeAudio()"></div>
    <div class="player-track" id="pt"></div>
    <div class="player-sub" id="ps"></div>
    <div class="player-waves" id="pw"></div>
    <div class="player-progress" onclick="seekAudio(event)"><div class="player-progress-fill" id="pf"></div></div>
    <div class="player-times"><span id="pct">0:00</span><span id="ptt">â€”</span></div>
    <div class="player-controls">
      <button class="ctrl" onclick="skipA(-15)">â® 15s</button>
      <button class="ctrl-main" id="pmb" onclick="toggleAudio()">â–¶</button>
      <button class="ctrl" onclick="skipA(15)">15s â­</button>
    </div>
    <div style="margin-top:20px;padding:12px 14px;background:rgba(76,175,130,0.05);border-radius:10px;font-size:12px;color:var(--text-soft);text-align:center;line-height:1.5;">
      ğŸŒ€ Installez-vous confortablement. Fermez les yeux. Laissez la voix vous guider dans l'induction.
    </div>
  </div>
</div>

<script>
// STATE
const S = JSON.parse(localStorage.getItem('marion-quest2') || '{}');
if (!S.xp) S.xp = 0;
if (!S.completed) S.completed = [];
if (!S.journal) S.journal = [];
function save() { localStorage.setItem('marion-quest2', JSON.stringify(S)); }

const LEVEL_XP   = [80,100,90,80,120,110,130,200];
const LEVEL_MSGS = [
  'Le Niveau 2 est maintenant disponible !',
  'Le Niveau 3 est maintenant disponible !',
  'Le Monde II s\'ouvre â€” Niveau 4 vous attend !',
  'Le Niveau 5 est disponible !',
  'Le Niveau 6 est disponible !',
  'Le Monde III s\'ouvre â€” Niveau 7 vous attend !',
  'Le Niveau Final est dÃ©bloquÃ©. ÃŠtes-vous prÃªte ?',
  'ğŸ‰ QuÃªte accomplie ! Marion, vous avez vaincu la peur de la peur.',
];
const LEVEL_EMOJIS = ['ğŸ§ ','ğŸ«','ğŸŒ€','ğŸŒ¬ï¸','ğŸ§','âš¡','ğŸš¶','ğŸ‘‘'];

// LEVELS
const LEVELS = [
  { name:'La Peur d\'avoir Peur', xp:80, steps:[
    {type:'read',emoji:'ğŸ˜±',title:'Qu\'est-ce que la peur d\'avoir peur ?',body:`<p>Marion, imaginez deux alarmes incendie : l'une se dÃ©clenche quand il y a vraiment du feu. <strong>L'autre se dÃ©clencheâ€¦ parce qu'elle a peur de se dÃ©clencher.</strong></p><p>C'est exactement ce qui se passe dans le trouble anxieux : votre cerveau a appris Ã  avoir peur des <em>symptÃ´mes de la peur elle-mÃªme</em> â€” les palpitations, les crampes, la nausÃ©eâ€¦</p><span class="highlight">ğŸ”‘ Le nom officiel : Â« anxiÃ©tÃ© intÃ©roceptive Â». Ce n'est pas de la faiblesse â€” c'est un mÃ©canisme d'apprentissage que votre cerveau peut dÃ©sapprendre.</span>`},
    {type:'quiz',emoji:'ğŸ§ ',title:'Quiz â€” Connaissez-vous votre alarme ?',question:'Que se passe-t-il dans le cercle de la peur d\'avoir peur ?',choices:[{text:'La peur d\'un danger extÃ©rieur rÃ©el',correct:false},{text:'La peur des symptÃ´mes de la peur eux-mÃªmes',correct:true},{text:'Une rÃ©action allergique',correct:false}],explanation:'Exact ! La peur d\'avoir peur, c\'est quand le cerveau sonne l\'alarme en voyant les signaux de l\'alarme elle-mÃªme.'},
    {type:'read',emoji:'ğŸ§¬',title:'Pourquoi votre corps rÃ©agit-il ainsi ?',body:`<p>Votre <strong>amygdale</strong> â€” le dÃ©tecteur de danger du cerveau â€” a mÃ©morisÃ© que certaines sensations physiques (crampes, nausÃ©es) sont associÃ©es Ã  un danger.</p><p>DÃ¨s qu'elle les dÃ©tecte, elle dÃ©clenche la rÃ©ponse de stress : adrÃ©naline, cortisolâ€¦ ce qui <em>amplifie</em> exactement ces sensations.</p><span class="danger">âš ï¸ Ce mÃ©canisme cherche Ã  vous protÃ©ger â€” mais il surÃ©value la menace.</span><span class="highlight">âœ… Ce que le cerveau apprend, il peut le dÃ©sapprendre. C'est l'objectif de cette quÃªte.</span>`},
    {type:'reflection',emoji:'ğŸ“',title:'Votre alarme Ã  vous',prompt:'Quelles sensations dÃ©clenchent gÃ©nÃ©ralement votre anxiÃ©tÃ© ? (crampes, douleurs abdominales, nausÃ©es, palpitationsâ€¦)'},
    {type:'read',emoji:'ğŸŒ±',title:'La premiÃ¨re vÃ©ritÃ© libÃ©ratrice',body:`<span class="highlight">ğŸ’š Ressentir de l'anxiÃ©tÃ© ne signifie PAS qu'il y a un danger rÃ©el. C'est votre systÃ¨me d'alarme qui se trompe de cible.</span><p>Les symptÃ´mes physiques que vous ressentez ne sont pas une menace. Ils sont inconfortables â€” mais ils ne sont pas dangereux.</p><p>Dans les prochains niveaux, vous allez apprendre Ã  <strong>recalibrer cette alarme</strong>, un outil Ã  la fois.</p>`},
  ]},
  { name:'Votre Corps n\'est pas l\'Ennemi', xp:100, steps:[
    {type:'read',emoji:'ğŸ«',title:'Le SCI & l\'anxiÃ©tÃ©',body:`<p>Marion, votre cÃ´lon irritable et votre anxiÃ©tÃ© parlent le mÃªme langage.</p><p>L'intestin possÃ¨de <strong>plus de 100 millions de neurones</strong>. On l'appelle le Â« deuxiÃ¨me cerveau Â». Il communique constamment avec le cerveau via le nerf vague.</p><span class="highlight">ğŸ”— Axe intestin-cerveau : quand le cerveau est stressÃ©, l'intestin se contracte. Quand l'intestin est douloureux, le cerveau s'affole. C'est bidirectionnel.</span>`},
    {type:'quiz',emoji:'ğŸ§ ',title:'Quiz â€” L\'axe intestin-cerveau',question:'Pourquoi l\'anxiÃ©tÃ© aggrave-t-elle le SCI ?',choices:[{text:'Parce que l\'anxiÃ©tÃ© affaiblit le systÃ¨me immunitaire',correct:false},{text:'Parce que le stress active le systÃ¨me nerveux et perturbe les contractions intestinales',correct:true},{text:'Parce que l\'anxiÃ©tÃ© change directement la flore',correct:false}],explanation:'Exact ! Le systÃ¨me nerveux autonome contrÃ´le les mouvements intestinaux. Sous stress, il dÃ©rÃ¨gle le transit.'},
    {type:'read',emoji:'ğŸ’›',title:'Le piÃ¨ge de la surveillance corporelle',body:`<p>Quand on a le SCI, on apprend Ã  <em>surveiller en permanence</em> son ventre. On scrute chaque sensation. On anticipe la prochaine crise.</p><span class="danger">âš ï¸ Ce comportement de surveillance amplifie les sensations. Attention portÃ©e = signal amplifiÃ©. C'est comme tourner le volume de la radio.</span><span class="highlight">ğŸ’¡ Briser ce cycle, c'est apprendre Ã  baisser le volume â€” pas Ã  supprimer les sensations, mais Ã  leur donner moins d'importance.</span>`},
    {type:'read',emoji:'ğŸ¤',title:'RÃ©conciliation avec votre corps',body:`<p>Votre corps n'est pas votre ennemi. Il fait de son mieux avec un systÃ¨me nerveux hypersensible.</p><span class="highlight">âœ¨ Exercice : posez votre main sur votre ventre. Respirez. Dites intÃ©rieurement : "Je ne suis pas en guerre avec toi. Je t'Ã©coute autrement."</span>`},
    {type:'reflection',emoji:'ğŸ“',title:'Votre relation Ã  votre corps',prompt:'Comment dÃ©cririez-vous votre relation Ã  votre corps en ce moment ? Qu\'aimeriez-vous qu\'elle devienne ?'},
    {type:'read',emoji:'ğŸŒŸ',title:'Ce que la science dit',body:`<p>Les Ã©tudes montrent que la <strong>TCC</strong> rÃ©duit significativement les symptÃ´mes du SCI â€” parfois autant que les mÃ©dicaments.</p><p>L'<strong>autohypnose intestinale</strong> est parmi les traitements les plus efficaces avec 80% d'amÃ©lioration dans certaines Ã©tudes.</p><span class="highlight">ğŸ¯ Ce n'est pas "dans votre tÃªte" â€” c'est dans votre systÃ¨me nerveux. Et le systÃ¨me nerveux, Ã§a s'entraÃ®ne.</span>`},
  ]},
  { name:'Le Cercle Vicieux', xp:90, steps:[
    {type:'read',emoji:'ğŸŒ€',title:'Cartographier votre cycle',body:`<p>Chaque personne anxieuse a son propre cycle. Mais tous partagent la mÃªme structure :</p><span class="highlight">ğŸ”µ DÃ©clencheur â†’ ğŸ”´ PensÃ©e catastrophique â†’ ğŸ˜° AnxiÃ©tÃ© â†’ ğŸ¤¢ SymptÃ´mes physiques â†’ ğŸ”µ DÃ©clencheur amplifiÃ©â€¦</span><p>Pour Marion, le cycle ressemble souvent Ã  :</p><span class="danger">Crampe intestinale â†’ "Et si c'est grave ?" â†’ AnxiÃ©tÃ© monte â†’ Ventre se contracte â†’ Crampes s'intensifient â†’ "Je savais que c'Ã©tait grave !"</span>`},
    {type:'quiz',emoji:'ğŸ§ ',title:'Identifier le dÃ©clencheur',question:'Dans un cycle anxieux liÃ© au SCI, quel est souvent le premier maillon ?',choices:[{text:'Une pensÃ©e catastrophique spontanÃ©e',correct:false},{text:'Une sensation physique (crampe, douleur, urgence)',correct:true},{text:'Un Ã©vÃ©nement extÃ©rieur stressant',correct:false}],explanation:'Souvent oui ! Une sensation intestinale dÃ©clenche une interprÃ©tation catastrophique qui gÃ©nÃ¨re de l\'anxiÃ©tÃ©, qui aggrave les symptÃ´mes.'},
    {type:'read',emoji:'ğŸ”',title:'Les comportements qui maintiennent le cycle',body:`<span class="danger">âŒ Ã‰viter certains aliments par peur â†’ Confirme que c'est dangereux<br>âŒ Rester proche des toilettes "au cas oÃ¹" â†’ Renforce la croyance que la catastrophe peut arriver<br>âŒ Chercher des causes mÃ©dicales â†’ Focalise l'attention sur le corps</span><span class="highlight">âœ… Ces comportements sont comprÃ©hensibles â€” mais ils alimentent le cycle. Les identifier est la premiÃ¨re Ã©tape pour les changer.</span>`},
    {type:'reflection',emoji:'ğŸ“',title:'Mon cycle personnel',prompt:'DÃ©crivez votre cercle vicieux : qu\'est-ce qui dÃ©clenche habituellement votre anxiÃ©tÃ© ? Que ressentez-vous ensuite ? Que faites-vous pour vous rassurer ?'},
    {type:'read',emoji:'âš”ï¸',title:'Les trois leviers de sortie',body:`<span class="highlight">1ï¸âƒ£ <strong>Changer l'interprÃ©tation</strong> â€” Restructurer la pensÃ©e catastrophique (Niveau 6)<br>2ï¸âƒ£ <strong>Calmer le corps</strong> â€” Respiration et hypnose (Niveaux 4 & 5)<br>3ï¸âƒ£ <strong>Modifier le comportement</strong> â€” Exposition graduÃ©e (Niveau 7)</span><p>Vous allez pratiquer les trois. Ensemble, ils sont redoutablement efficaces.</p>`},
  ]},
  { name:'Souffle & CohÃ©rence', xp:80, steps:[
    {type:'read',emoji:'ğŸŒ¬ï¸',title:'Pourquoi respirer change tout',body:`<p>Votre systÃ¨me nerveux a deux modes : <strong>sympathique</strong> (alarme) et <strong>parasympathique</strong> (repos, digestion).</p><p>Quand vous Ãªtes anxieuse, le mode sympathique domine â€” il contracte l'intestin, amplifie toutes les sensations.</p><span class="highlight">ğŸ’¡ La respiration est le seul levier conscient sur le systÃ¨me nerveux autonome. Une expiration longue active directement le nerf vague â€” le frein naturel de l'anxiÃ©tÃ©.</span>`},
    {type:'read',emoji:'ğŸ’š',title:'La technique 4-4-6',body:`<span class="highlight">ğŸŒ¬ï¸ Inspirez par le nez : <strong>4 secondes</strong><br>â¸ Retenez doucement : <strong>4 secondes</strong><br>ğŸ’¨ Expirez lentement par la bouche : <strong>6 secondes</strong></span><p>L'expiration longue stimule le nerf vague et envoie un signal de sÃ©curitÃ© Ã  votre intestin.</p>`},
    {type:'breath',emoji:'ğŸŒ¬ï¸',title:'Pratiquez maintenant â€” 3 cycles',prompt:'Appuyez sur l\'orbe pour dÃ©marrer votre premiÃ¨re pratique guidÃ©e.'},
    {type:'reflection',emoji:'ğŸ“',title:'AprÃ¨s la respiration',prompt:'Comment vous sentez-vous aprÃ¨s ces 3 cycles ? Avez-vous remarquÃ© un changement dans votre ventre, votre poitrine ?'},
    {type:'read',emoji:'ğŸ¯',title:'Votre mission quotidienne',body:`<span class="highlight">ğŸŒ… Matin : 3 minutes avant de sortir du lit<br>âš¡ Au dÃ©clencheur : dÃ¨s qu'une crampe ou anxiÃ©tÃ© apparaÃ®t<br>ğŸŒ™ Soir : 5 minutes avant de dormir</span><p>Au bout de 3 semaines, votre systÃ¨me nerveux aura appris Ã  s'auto-rÃ©guler. Votre intestin aussi en bÃ©nÃ©ficiera.</p>`},
  ]},
  { name:'Le Sanctuaire IntÃ©rieur', xp:120, steps:[
    {type:'read',emoji:'ğŸ§',title:'L\'autohypnose : qu\'est-ce que c\'est vraiment ?',body:`<p>L'hypnose n'est pas du sommeil ni de la magie. C'est un <strong>Ã©tat naturel de concentration focalisÃ©e</strong> â€” comme quand vous Ãªtes absorbÃ©e dans un film.</p><p>En hypnose, le cerveau passe en ondes alpha et thÃªta â€” des Ã©tats oÃ¹ le cerveau Ã©motionnel devient plus rÃ©ceptif aux suggestions de changement.</p><span class="highlight">âœ¨ L'hypnose intestinale rÃ©duit la sensibilitÃ© viscÃ©rale â€” l'intestin rÃ©agit moins fort aux stimuli normaux.</span>`},
    {type:'read',emoji:'ğŸŒŠ',title:'L\'induction : comment Ã§a marche',body:`<span class="highlight">Structure de votre sÃ©ance :<br>ğŸŒ¬ï¸ <strong>Induction</strong> (5-8 min) â€” Relaxation progressive du corps<br>ğŸŒŠ <strong>Approfondissement</strong> (3-5 min) â€” Descendre plus profond<br>ğŸ¯ <strong>Travail ciblÃ©</strong> (8-12 min) â€” Suggestions pour l'anxiÃ©tÃ© et l'intestin<br>ğŸŒ… <strong>RÃ©veil en douceur</strong> (2-3 min)</span>`},
    {type:'audio',emoji:'ğŸ§',title:'Votre premiÃ¨re sÃ©ance',sub:'Induction â†’ Relaxation & LÃ¢cher-prise',src:'audio/seance-relaxation.mp3',duration:'~20 min',note:'Installez-vous confortablement. Casque recommandÃ©. Bonne sÃ©ance, Marion ğŸŒ¿'},
    {type:'reflection',emoji:'ğŸ“',title:'AprÃ¨s votre sÃ©ance',prompt:'Qu\'avez-vous ressenti pendant la sÃ©ance ? Y a-t-il eu un moment particuliÃ¨rement puissant ?'},
  ]},
  { name:'Restructurer les PensÃ©es', xp:110, steps:[
    {type:'read',emoji:'ğŸ’­',title:'Les pensÃ©es automatiques catastrophiques',body:`<p>Quand l'anxiÃ©tÃ© frappe, le cerveau produit des pensÃ©es automatiques rapides, souvent extrÃªmes.</p><span class="danger">Exemples typiques liÃ©s au SCI :<br>â€¢ "Cette douleur va devenir incontrÃ´lable"<br>â€¢ "Je vais avoir une crise en public et me ridiculiser"<br>â€¢ "Mon corps va me lÃ¢cher"</span>`},
    {type:'quiz',emoji:'ğŸ§ ',title:'ReconnaÃ®tre le piÃ¨ge cognitif',question:'Une pensÃ©e intense et convaincante est-elle forcÃ©ment vraie ?',choices:[{text:'Oui, l\'intensitÃ© indique l\'importance',correct:false},{text:'Non, l\'intensitÃ© Ã©motionnelle ne prouve pas la rÃ©alitÃ©',correct:true},{text:'Cela dÃ©pend de la situation',correct:false}],explanation:'Exactement ! L\'intensitÃ© d\'une pensÃ©e reflÃ¨te l\'Ã©tat Ã©motionnel, pas la rÃ©alitÃ© factuelle.'},
    {type:'read',emoji:'âš–ï¸',title:'La technique du procureur & de l\'avocat',body:`<span class="highlight">ğŸ”´ <strong>La pensÃ©e</strong> : "Cette douleur va devenir incontrÃ´lable"<br><br>âš–ï¸ <strong>Le procureur</strong> (contre la pensÃ©e) :<br>â€¢ "Les autres fois, la douleur a passÃ©"<br>â€¢ "Mon mÃ©decin a vÃ©rifiÃ© â€” ce n'est pas dangereux"<br>â€¢ "J'ai dÃ©jÃ  gÃ©rÃ© pire"<br><br>âœ… <strong>ReformulÃ©e</strong> : "Cette douleur est inconfortable mais elle passera. J'ai les outils pour la traverser."</span>`},
    {type:'reflection',emoji:'ğŸ“',title:'Votre procÃ¨s intÃ©rieur',prompt:'Prenez une pensÃ©e catastrophique rÃ©cente. Ã‰crivez les arguments contre cette pensÃ©e, puis reformulez-la de faÃ§on plus Ã©quilibrÃ©e.'},
    {type:'read',emoji:'ğŸŒŸ',title:'La rÃ¨gle des 3 questions',body:`<span class="highlight">â“ <strong>1. C'est quoi la preuve rÃ©elle ?</strong><br>â“ <strong>2. Quelle est la probabilitÃ© rÃ©aliste que le pire arrive ?</strong><br>â“ <strong>3. Si le pire arrivait, je pourrais y faire face comment ?</strong></span><p>La troisiÃ¨me question est la plus puissante â€” elle brise le sentiment d'impuissance.</p>`},
    {type:'read',emoji:'ğŸ’ª',title:'Vous Ãªtes plus forte que vos pensÃ©es',body:`<span class="highlight">ğŸ’¡ Nouvelle posture : "J'ai la pensÃ©e que [quelque chose de catastrophique], mais je n'ai pas Ã  la croire ni Ã  lui obÃ©ir."</span><p>Ce petit espace entre vous et la pensÃ©e â€” c'est la libertÃ©. C'est lÃ  que la guÃ©rison se construit.</p>`},
  ]},
  { name:'L\'Exposition GraduÃ©e', xp:130, steps:[
    {type:'read',emoji:'ğŸš¶',title:'Pourquoi Ã©viter aggrave tout',body:`<p>L'Ã©vitement est une rÃ©ponse naturelle Ã  l'anxiÃ©tÃ©. Mais chaque Ã©vitement apprend au cerveau que la situation Ã©tait bien dangereuse.</p><span class="danger">Exemples avec le SCI :<br>â€¢ Refuser des sorties de peur d'une crise<br>â€¢ Ne jamais s'Ã©loigner des toilettes connues<br>â€¢ Limiter le rÃ©gime alimentaire par peur</span><span class="highlight">âœ… Chaque fois que vous Ã©vitez, vous renforcez : "C'est dangereux." L'exposition dit : "Je peux le traverser."</span>`},
    {type:'read',emoji:'ğŸªœ',title:'L\'Ã©chelle d\'exposition',body:`<span class="highlight">ğŸ  Niveau 1 â€” Sortir seule 30 min dans le quartier<br>ğŸ›’ Niveau 2 â€” Faire les courses seule<br>ğŸšŒ Niveau 3 â€” Prendre les transports en commun<br>ğŸ½ï¸ Niveau 4 â€” DÃ®ner au restaurant<br>âœˆï¸ Niveau 5 â€” Partir en voyage</span><p>Votre Ã©chelle est personnelle. Construisez-la avec votre thÃ©rapeute.</p>`},
    {type:'quiz',emoji:'ğŸ§ ',title:'L\'objectif de l\'exposition',question:'Pendant une exposition, que cherche-t-on Ã  obtenir ?',choices:[{text:'Supprimer immÃ©diatement l\'anxiÃ©tÃ©',correct:false},{text:'Rester dans la situation jusqu\'Ã  ce que l\'anxiÃ©tÃ© diminue naturellement',correct:true},{text:'Prouver que la situation n\'est pas anxiogÃ¨ne',correct:false}],explanation:'Exact ! L\'objectif est de rester assez longtemps pour que le cerveau apprenne que la situation est sÃ»re.'},
    {type:'reflection',emoji:'ğŸ“',title:'Votre premiÃ¨re marche',prompt:'Quelle serait votre exposition numÃ©ro 1 â€” la plus facile, mais que vous Ã©vitez quand mÃªme ? Engagez-vous Ã  la faire cette semaine.'},
    {type:'read',emoji:'ğŸ†',title:'La rÃ¨gle d\'or',body:`<span class="highlight">ğŸ”‘ Ne jamais quitter la situation au pic de l'anxiÃ©tÃ©. Restez jusqu'Ã  ce qu'elle redescende d'au moins 30-40%.</span><p>Partir au pic confirme le danger. Rester jusqu'Ã  la descente apprend la sÃ©curitÃ©. Vous pouvez utiliser la respiration 4-4-6 pendant l'exposition.</p>`},
  ]},
  { name:'Vaincre la Peur de la Peur', xp:200, steps:[
    {type:'read',emoji:'ğŸ‰',title:'Le combat final',body:`<p>Marion, vous avez traversÃ© 7 niveaux. Vous avez compris la mÃ©canique de la peur, appris Ã  respirer, restructurÃ© vos pensÃ©es, osÃ© l'exposition.</p><p><strong>Le combat final, c'est l'intÃ©gration.</strong></p><span class="highlight">La peur d'avoir peur se dissout progressivement, chaque fois que vous choisissez de ne pas lui obÃ©ir aveuglÃ©ment.</span>`},
    {type:'read',emoji:'ğŸ—ºï¸',title:'Votre carte de ressources',body:`<span class="highlight">ğŸŒ¬ï¸ <strong>Respiration 4-4-6</strong> â€” DÃ¨s qu'une anxiÃ©tÃ© monte<br>ğŸ’­ <strong>3 questions</strong> â€” Face Ã  une pensÃ©e catastrophique<br>ğŸ§ <strong>Hypnose</strong> â€” SÃ©ance hebdomadaire minimum<br>ğŸš¶ <strong>Exposition</strong> â€” Une petite marche par semaine<br>ğŸ““ <strong>Journal</strong> â€” Observer sans juger<br>ğŸ¤ <strong>Compassion corporelle</strong> â€” Votre corps est un alliÃ©</span>`},
    {type:'reflection',emoji:'ğŸŒŸ',title:'Ce que j\'ai appris sur moi',prompt:'Qu\'avez-vous dÃ©couvert sur vous-mÃªme au cours de cette quÃªte ? Qu\'est-ce qui a changÃ© dans votre faÃ§on de voir vos symptÃ´mes ?'},
    {type:'audio',emoji:'ğŸ§',title:'SÃ©ance finale â€” Paix Intestinale',sub:'Votre sÃ©ance d\'hypnose dÃ©diÃ©e au SCI',src:'audio/seance-sci.mp3',duration:'~22 min',note:'Cette sÃ©ance travaille sur la dÃ©tente intestinale et la confiance en votre corps.'},
    {type:'read',emoji:'ğŸ‘‘',title:'Marion, vous avez gagnÃ©',body:`<p>Terminer ce parcours ne signifie pas que vous n'aurez plus jamais d'anxiÃ©tÃ© ni de crise de SCI.</p><p>Cela signifie que vous avez des outils. Que vous avez prouvÃ©, niveau aprÃ¨s niveau, que vous pouvez <em>traverser</em> l'inconfort sans vous y noyer.</p><span class="highlight">ğŸŒ¿ La libertÃ© ne vient pas de l'absence de peur. Elle vient de la capacitÃ© Ã  continuer Ã  vivre malgrÃ© elle. Vous l'avez, Marion. ğŸ’š</span>`},
  ]},
];

// NAV
function nav(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0,0);
  updateUI();
}

// UPDATE UI
function updateUI() {
  const maxXP = 810;
  const pct = Math.min(100,(S.xp/maxXP)*100);
  const lv = Math.floor(S.xp/70)+1;
  const ixb = document.getElementById('intro-xp-bar'); if(ixb) ixb.style.width=pct+'%';
  const ixt = document.getElementById('intro-xp-text'); if(ixt) ixt.textContent=S.xp+' XP';
  const ilt = document.getElementById('intro-level-text'); if(ilt) ilt.textContent='Niveau '+lv;
  const mxf = document.getElementById('map-xp-fill'); if(mxf) mxf.style.width=pct+'%';
  const mxl = document.getElementById('map-xp-label'); if(mxl) mxl.textContent=S.xp+' XP';
  const sl = document.getElementById('stat-levels'); if(sl) sl.textContent=S.completed.length;
  const sx = document.getElementById('stat-xp'); if(sx) sx.textContent=S.xp;
  LEVELS.forEach((_,i)=>{
    const card=document.getElementById('lcard-'+i);
    const lock=document.getElementById('lock-'+i);
    const check=document.getElementById('check-'+i);
    if(!card) return;
    const done=S.completed.includes(i);
    const unlocked=i===0||S.completed.includes(i-1);
    if(done){card.classList.remove('locked');card.classList.add('completed');if(lock)lock.style.display='none';if(check)check.style.display='inline';}
    else if(unlocked){card.classList.remove('locked');if(lock)lock.style.display='none';if(check)check.style.display='none';}
    else{card.classList.add('locked');if(lock)lock.style.display='inline';if(check)check.style.display='none';}
  });
  renderJournal();
}

// PLAY
let curLv=0, curSt=0, selAns=null;

function startLevel(idx) {
  const unlocked=idx===0||S.completed.includes(idx-1);
  if(!unlocked){showToast('ğŸ”’ Terminez le niveau prÃ©cÃ©dent d\'abord !');return;}
  curLv=idx; curSt=0; selAns=null;
  nav('play'); renderPlay();
}

function renderPlay() {
  const lv=LEVELS[curLv];
  const st=lv.steps[curSt];
  document.getElementById('play-level-num').textContent='Niveau '+(curLv+1);
  document.getElementById('play-level-name').textContent=lv.name;
  document.getElementById('play-xp-reward').textContent='+'+lv.xp+' XP';
  const dots=document.getElementById('step-dots');
  dots.innerHTML='';
  lv.steps.forEach((_,i)=>{const d=document.createElement('div');d.className='step-dot '+(i<curSt?'done':i===curSt?'active':'');dots.appendChild(d);});
  const body=document.getElementById('play-body');
  body.innerHTML='';
  const card=document.createElement('div');
  card.className='step-card';
  const isLast=curSt>=lv.steps.length-1;
  const nextText=isLast?'âœ¨ Terminer le niveau':'Continuer â†’';

  if(st.type==='read'){
    card.innerHTML=`<div class="step-emoji">${st.emoji}</div><div class="step-title">${st.title}</div><div class="step-text">${st.body}</div>`;
    document.getElementById('next-btn').style.display='block';
    document.getElementById('next-btn').textContent=nextText;
  }
  if(st.type==='quiz'){
    selAns=null;
    let ch=st.choices.map((c,i)=>`<button class="choice-btn" id="ch-${i}" onclick="pickAns(${i},${c.correct})">${c.text}</button>`).join('');
    card.innerHTML=`<div class="step-emoji">${st.emoji}</div><div class="step-title">${st.title}</div><div class="step-text" style="margin-bottom:4px">${st.question}</div><div class="choices">${ch}</div><div id="qfb" style="margin-top:12px;font-size:13px;line-height:1.5;display:none"></div>`;
    document.getElementById('next-btn').style.display='none';
  }
  if(st.type==='reflection'){
    card.innerHTML=`<div class="step-emoji">${st.emoji}</div><div class="step-title">${st.title}</div><div class="step-text" style="margin-bottom:4px">${st.prompt}</div><textarea class="reflection-input" id="refl-ta" placeholder="Ã‰crivez iciâ€¦"></textarea>`;
    document.getElementById('next-btn').style.display='block';
    document.getElementById('next-btn').textContent=nextText;
  }
  if(st.type==='breath'){
    card.innerHTML=`<div class="step-emoji">${st.emoji}</div><div class="step-title">${st.title}</div><div class="step-text">${st.prompt}</div>
    <div class="breath-mini">
      <div class="breath-orb" id="borb" onclick="startBreath()">Appuyez</div>
      <div class="breath-instruction" id="binst">Inspirez 4 â€” Retenez 4 â€” Expirez 6</div>
      <div class="breath-timer" id="btimer" style="display:none">4</div>
    </div>`;
    document.getElementById('next-btn').style.display='block';
    document.getElementById('next-btn').textContent=nextText;
  }
  if(st.type==='audio'){
    card.innerHTML=`<div class="step-emoji">${st.emoji}</div><div class="step-title">${st.title}</div><div class="step-text"><p>${st.note}</p></div>
    <div class="audio-play-card" onclick="openAudio('${st.title}','${st.sub}','${st.src}','${st.duration}')">
      <div class="audio-play-btn">â–¶</div>
      <div><div class="audio-play-title">${st.title}</div><div class="audio-play-sub">${st.sub}</div><div class="audio-play-duration">ğŸ• ${st.duration}</div></div>
    </div>`;
    document.getElementById('next-btn').style.display='block';
    document.getElementById('next-btn').textContent=nextText;
  }
  body.appendChild(card);
  window.scrollTo(0,0);
}

function pickAns(idx, correct) {
  if(selAns!==null) return;
  selAns=idx;
  const st=LEVELS[curLv].steps[curSt];
  st.choices.forEach((_,i)=>{const b=document.getElementById('ch-'+i);if(b){b.disabled=true;if(i===idx)b.classList.add(correct?'correct':'wrong');}});
  const fb=document.getElementById('qfb');
  if(fb){fb.style.display='block';fb.textContent=(correct?'âœ… Excellent ! ':'âŒ Pas tout Ã  fait â€” ')+st.explanation;fb.style.color=correct?'var(--green)':'var(--red)';}
  const isLast=curSt>=LEVELS[curLv].steps.length-1;
  document.getElementById('next-btn').style.display='block';
  document.getElementById('next-btn').textContent=isLast?'âœ¨ Terminer le niveau':'Continuer â†’';
}

function nextStep() {
  const lv=LEVELS[curLv];
  if(curSt<lv.steps.length-1){curSt++;selAns=null;renderPlay();}
  else{completeLevel();}
}

function completeLevel() {
  if(!S.completed.includes(curLv)){S.completed.push(curLv);S.xp+=LEVELS[curLv].xp;save();}
  document.getElementById('reward-emoji').textContent=LEVEL_EMOJIS[curLv];
  document.getElementById('reward-title').textContent=curLv===7?'ğŸ‰ QuÃªte accomplie !':'Niveau accompli !';
  document.getElementById('reward-sub').textContent=LEVELS[curLv].name+' maÃ®trisÃ©. Vous avancez, Marion.';
  document.getElementById('reward-xp').textContent='âš¡ +'+LEVELS[curLv].xp+' XP';
  document.getElementById('reward-unlock-text').textContent=LEVEL_MSGS[curLv];
  nav('reward');
}

// BREATHING
let breathOn=false, breathTO=null;
function startBreath(){
  if(breathOn){clearTimeout(breathTO);breathOn=false;const o=document.getElementById('borb');if(o){o.className='breath-orb';o.textContent='Appuyez';}const t=document.getElementById('btimer');if(t)t.style.display='none';return;}
  breathOn=true;runPhase(0,0);
}
function runPhase(cycle,phase){
  if(!breathOn) return;
  const ps=[{label:'Inspirez',dur:4,cls:'expand'},{label:'Retenez',dur:4,cls:''},{label:'Expirez',dur:6,cls:'shrink'}];
  const p=ps[phase];
  const orb=document.getElementById('borb');
  const inst=document.getElementById('binst');
  const timer=document.getElementById('btimer');
  if(!orb){breathOn=false;return;}
  orb.className='breath-orb '+p.cls;
  orb.textContent=p.label;
  if(inst)inst.textContent=p.label+'â€¦';
  if(timer){timer.style.display='block';timer.textContent=p.dur;}
  let cnt=p.dur;
  function tick(){
    if(!breathOn) return;
    cnt--;
    if(timer)timer.textContent=cnt;
    if(cnt>0){breathTO=setTimeout(tick,1000);}
    else{
      const np=(phase+1)%3;
      const nc=np===0?cycle+1:cycle;
      if(nc>=3){breathOn=false;if(orb){orb.className='breath-orb';orb.textContent='âœ… Bravo !';}if(inst)inst.textContent='3 cycles accomplis !';if(timer)timer.style.display='none';return;}
      breathTO=setTimeout(()=>runPhase(nc,np),500);
    }
  }
  breathTO=setTimeout(tick,1000);
}

// JOURNAL
let pickedEmoji=null;
function pickEmotion(el,e){document.querySelectorAll('#journal-sc .choice-btn').forEach(b=>b.classList.remove('correct'));el.classList.add('correct');pickedEmoji=e;}
function saveJournal(){
  const ta=document.getElementById('journal-ta');
  const text=ta?ta.value.trim():'';
  if(!text&&!pickedEmoji){showToast('SÃ©lectionnez une Ã©motion ou Ã©crivez quelque chose ğŸ’¬');return;}
  S.journal.unshift({emoji:pickedEmoji||'ğŸ“',text:text||'(Sans note)',date:new Date().toLocaleDateString('fr-FR',{weekday:'short',day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'})});
  if(S.journal.length>40)S.journal=S.journal.slice(0,40);
  S.xp+=5; save();
  if(ta)ta.value='';
  pickedEmoji=null;
  document.querySelectorAll('#journal-sc .choice-btn').forEach(b=>b.classList.remove('correct'));
  renderJournal();
  showToast('EntrÃ©e enregistrÃ©e âœ… +5 XP');
}
function renderJournal(){
  const c=document.getElementById('journal-entries');
  if(!c) return;
  if(!S.journal.length){c.innerHTML='<div style="font-size:13px;color:var(--text-muted);text-align:center;padding:20px 0;">Vos entrÃ©es apparaÃ®tront ici.</div>';return;}
  c.innerHTML=S.journal.map(e=>`<div style="background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px 16px;"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;"><span style="font-size:22px">${e.emoji}</span><span style="font-size:11px;color:var(--text-muted)">${e.date}</span></div><div style="font-size:13px;color:var(--text-soft);line-height:1.5">${e.text}</div></div>`).join('');
}

// AUDIO
let aud=null, audOn=false;
function buildWaves(){const pw=document.getElementById('pw');pw.innerHTML='';[8,16,28,20,38,26,12,34,22,10,36,18,42,14,30,26,10,38,20,16,32].forEach((h,i)=>{const b=document.createElement('div');b.className='wbar';b.style.height=h+'px';b.style.animationDelay=(i*0.055)+'s';pw.appendChild(b);});}
function openAudio(title,sub,src,dur){
  document.getElementById('pt').textContent=title;
  document.getElementById('ps').textContent=sub;
  document.getElementById('ptt').textContent=dur;
  document.getElementById('pf').style.width='0%';
  document.getElementById('pct').textContent='0:00';
  buildWaves();
  document.getElementById('po').classList.add('open');
  if(aud)aud.pause();
  aud=new Audio(src);
  aud.addEventListener('timeupdate',updAud);
  aud.addEventListener('loadedmetadata',()=>{const m=Math.floor(aud.duration/60);const s=String(Math.floor(aud.duration%60)).padStart(2,'0');document.getElementById('ptt').textContent=m+':'+s;});
  aud.addEventListener('ended',()=>{audOn=false;document.getElementById('pmb').textContent='â–¶';});
  aud.play().then(()=>{audOn=true;document.getElementById('pmb').textContent='â¸';}).catch(()=>showToast('âš ï¸ Fichier audio introuvable â€” ajoutez-le dans /audio/'));
}
function closeAudio(){document.getElementById('po').classList.remove('open');if(aud){aud.pause();audOn=false;}}
function toggleAudio(){if(!aud)return;if(audOn){aud.pause();audOn=false;document.getElementById('pmb').textContent='â–¶';}else{aud.play();audOn=true;document.getElementById('pmb').textContent='â¸';}}
function updAud(){if(!aud||!aud.duration)return;const p=(aud.currentTime/aud.duration)*100;document.getElementById('pf').style.width=p+'%';const m=Math.floor(aud.currentTime/60);const s=String(Math.floor(aud.currentTime%60)).padStart(2,'0');document.getElementById('pct').textContent=m+':'+s;}
function seekAudio(e){if(!aud)return;aud.currentTime=(e.offsetX/e.currentTarget.offsetWidth)*aud.duration;}
function skipA(sec){if(!aud)return;aud.currentTime=Math.max(0,aud.currentTime+sec);}
document.getElementById('po').addEventListener('click',e=>{if(e.target===document.getElementById('po'))closeAudio();});

// TOAST
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2800);}

// INIT
updateUI();
</script>
</body>
</html>
